{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="vintage-form-container">
  <div class="vintage-form-box">
    <h2 class="vintage-form-title">
      <i class="fas fa-edit"></i> {{ title }}
    </h2>

    <form method="post" enctype="multipart/form-data" class="vintage-form">
      {% csrf_token %}

      <!-- Champs principaux -->
      {% for field in form.visible_fields %}
        {% if field.name not in 'raw_genres finished_year finished_month finished_day' %}
          <div class="vintage-form-group slim">
            <label for="{{ field.id_for_label }}" class="vintage-label">
              {{ field.label }}
            </label>
            {{ field }}
            {% if field.help_text %}
              <small class="vintage-help-text">{{ field.help_text }}</small>
            {% endif %}
          </div>
        {% endif %}
      {% endfor %}

      <!-- Date de fin -->
      <div class="vintage-date-group slim">
        <label class="vintage-label">Date de fin</label>
        <div class="date-fields">
          <div class="vintage-form-group slim">
            {{ form.finished_year }}
          </div>
          <div class="vintage-form-group slim">
            {{ form.finished_month }}
          </div>
          <div class="vintage-form-group slim">
            {{ form.finished_day }}
          </div>
          <button type="button" id="set-today" class="vintage-small-button">
            <i class="fas fa-calendar-day"></i> Aujourd'hui
          </button>
        </div>
      </div>

      <!-- Genres - Version simplifiée -->
      <div class="vintage-form-group slim">
        <label for="genre-select" class="vintage-label">Genres</label>
        <select id="genre-select" multiple="multiple" class="vintage-multiselect">
          {% for genre in all_genres %}
            <option value="{{ genre.name }}">{{ genre.name }}</option>
          {% endfor %}
        </select>
        {{ form.raw_genres }}
      </div>

      <!-- Erreurs -->
      {% if form.errors %}
        <div class="vintage-form-errors">
          <ul>
            {% for field in form %}
              {% for error in field.errors %}
                <li><i class="fas fa-exclamation-circle"></i> {{ field.label }} : {{ error }}</li>
              {% endfor %}
            {% endfor %}
          </ul>
        </div>
      {% endif %}

      <button type="submit" class="vintage-submit-button slim">
        <i class="fas fa-save"></i> Enregistrer
      </button>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
  /* Base vintage */
  .vintage-form-container {
    padding: 1rem;
    background-color: #f5f1e8;
  }
  
  .vintage-form-box {
    max-width: 600px;
    margin: 0 auto;
    padding: 1.5rem;
    background-color: #e8e0d0;
    border: 1px solid #b8a98f;
  }
  
  .vintage-form-title {
    color: #5c4b37;
    text-align: center;
    margin-bottom: 1.5rem;
    font-size: 1.5rem;
    border-bottom: 1px solid #b8a98f;
    padding-bottom: 0.5rem;
  }
  
  /* Champs plus fins */
  .vintage-form-group.slim {
    margin-bottom: 1rem;
  }
  
  .vintage-label {
    display: block;
    margin-bottom: 0.3rem;
    color: #5c4b37;
    font-size: 0.9rem;
  }
  
  .vintage-form input[type="text"],
  .vintage-form input[type="number"],
  .vintage-form input[type="file"],
  .vintage-form textarea,
  .vintage-form select {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #b8a98f;
    background-color: #f9f6ee;
    font-size: 0.9rem;
  }
  
  /* Multiselect plus sobre */
  .vintage-multiselect .select2-selection {
    border: 1px solid #b8a98f !important;
    background-color: #f9f6ee !important;
    min-height: 32px !important;
    padding: 2px !important;
  }
  
  .vintage-multiselect .select2-selection__choice {
    background-color: #d4c9b1 !important;
    border: 1px solid #b8a98f !important;
    color: #3a3226 !important;
    padding: 0 5px !important;
  }
  
  /* Date group compact */
  .vintage-date-group.slim {
    margin-bottom: 1rem;
  }
  
  .date-fields {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }
  
  .date-fields .vintage-form-group {
    flex: 1;
    margin-bottom: 0;
  }
  
  .vintage-small-button {
    padding: 0.4rem 0.6rem;
    background-color: #8b7a5e;
    color: white;
    border: none;
    font-size: 0.8rem;
    cursor: pointer;
  }
  
  /* Bouton submit */
  .vintage-submit-button.slim {
    width: auto;
    padding: 0.6rem 1.5rem;
    margin-top: 1rem;
    background-color: #8b7a5e;
    color: white;
    border: none;
    font-size: 0.9rem;
  }
  
  /* Erreurs */
  .vintage-form-errors {
    background-color: #f3d9da;
    padding: 0.5rem;
    margin: 1rem 0;
    font-size: 0.9rem;
  }
</style>

<script>
$(document).ready(function() {
  // Initialisation Select2
  $('#genre-select').select2({
    width: '100%',
    placeholder: "Sélectionnez des genres",
    allowClear: true,
    tags: true,
    tokenSeparators: [',']
  });

  // Bouton aujourd'hui
  $('#set-today').click(function() {
    const today = new Date();
    $('#id_finished_year').val(today.getFullYear());
    $('#id_finished_month').val(today.getMonth() + 1);
    $('#id_finished_day').val(today.getDate());
  });

  // Sauvegarde des genres
  $('form').submit(function() {
    const selected = $('#genre-select').val();
    $('input[name="raw_genres"]').val(selected ? selected.join(',') : '');
  });
});
</script>
{% endblock %}
