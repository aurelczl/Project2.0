{% extends "base.html" %}

{% block content %}
  <div class="vintage-container">
    <!-- En-tête de bienvenue -->
    <div class="vintage-header">
      <h1>Bienvenue {{ user.username }}</h1>
      <p class="vintage-subtitle">Votre collection personnelle</p>
    </div>

    <div class="vintage-library-container">
    <h2 class="vintage-library-title">
        <i class="fas fa-book-open"></i> Ma Bibliothèque Visuelle
    </h2>

    <div id="filters" class="vintage-filters">
        <div class="vintage-filter-group">
            <h3 class="vintage-filter-title"><i class="fas fa-folder"></i> Catégories</h3>
            <div id="category-filters" class="vintage-btn-group">
                <button class="vintage-filter-btn active" data-category="all" onclick="filterItems()">Tous</button>
                <button class="vintage-filter-btn" data-category="book" onclick="filterItems()">Livres</button>
                <button class="vintage-filter-btn" data-category="movie" onclick="filterItems()">Films</button>
                <button class="vintage-filter-btn" data-category="series" onclick="filterItems()">Séries</button>
            </div>
        </div>

        <div class="vintage-filter-group">
            <h3 class="vintage-filter-title"><i class="fas fa-tags"></i> Genres</h3>
            <div id="genre-filters" class="vintage-checkbox-group">
                {% for genre in all_genres %}
                <label class="vintage-genre-label">
                    <input type="checkbox" class="vintage-genre-checkbox" value="{{ genre.name }}" onchange="filterItems()">
                    <span class="vintage-genre-text">{{ genre.name }}</span>
                </label>
                {% endfor %}
            </div>
        </div>
    </div>

    <div id="bibli-container" class="vintage-grid">
        {% for item in items %}
        {% if item.image %}
        <a href="{% url 'item_detail' model_name=item.model_name item_id=item.id %}" class="vintage-item">
            <img src="{{ item.image.url }}" 
                 alt="{{ item.title }}" 
                 data-category="{{ item.model_name }}"
                 data-genres="{{ item.genres.all|join:',' }}"
                 style="max-height: {{ item.display_size }}px;"
                 class="vintage-item-img">
            <div class="vintage-item-overlay">{{ item.title }}</div>
        </a>
        {% endif %}
        {% endfor %}
    </div>
</div>

<style>
    /* Conteneur principal */
    .vintage-library-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f1e8;
        font-family: 'Times New Roman', serif;
    }

    /* Titre */
    .vintage-library-title {
        color: #5c4b37;
        text-align: center;
        margin-bottom: 25px;
        font-size: 2rem;
        border-bottom: 2px solid #8b7a5e;
        padding-bottom: 10px;
    }

    /* Filtres */
    .vintage-filters {
        background-color: #e8e0d0;
        padding: 15px;
        border: 1px solid #8b7a5e;
        margin-bottom: 25px;
    }

    .vintage-filter-group {
        margin-bottom: 15px;
    }

    .vintage-filter-title {
        color: #5c4b37;
        font-size: 1.2rem;
        margin-bottom: 10px;
    }

    /* Boutons de catégorie */
    .vintage-btn-group {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .vintage-filter-btn {
        padding: 6px 12px;
        background-color: #d4c9b1;
        border: 1px solid #8b7a5e;
        color: #3a3226;
        cursor: pointer;
        transition: all 0.3s;
        font-family: 'Times New Roman', serif;
    }

    .vintage-filter-btn:hover, .vintage-filter-btn.active {
        background-color: #8b7a5e;
        color: #f9f6ee;
    }

    /* Checkbox de genres */
    .vintage-checkbox-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .vintage-genre-label {
        display: flex;
        align-items: center;
        cursor: pointer;
    }

    .vintage-genre-checkbox {
        appearance: none;
        width: 16px;
        height: 16px;
        border: 1px solid #8b7a5e;
        background-color: #f9f6ee;
        margin-right: 6px;
        position: relative;
        cursor: pointer;
    }

    .vintage-genre-checkbox:checked {
        background-color: #8b7a5e;
    }

    .vintage-genre-checkbox:checked::after {
        content: "✓";
        position: absolute;
        color: #f9f6ee;
        font-size: 12px;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    .vintage-genre-text {
        color: #3a3226;
        font-size: 0.9rem;
    }

    /* Grille d'items */
    .vintage-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 20px;
    }

    .vintage-item {
        position: relative;
        transition: transform 0.3s;
        border: 1px solid #8b7a5e;
        background-color: #e8e0d0;
        padding: 5px;
    }

    .vintage-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .vintage-item-img {
        width: 100%;
        height: auto;
        display: block;
        object-fit: cover;
    }

    .vintage-item-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: rgba(91, 75, 55, 0.8);
        color: #f9f6ee;
        padding: 5px;
        font-size: 0.9rem;
        text-align: center;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .vintage-item:hover .vintage-item-overlay {
        opacity: 1;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .vintage-grid {
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        }
        
        .vintage-filter-title {
            font-size: 1rem;
        }
        
        .vintage-filter-btn {
            padding: 4px 8px;
            font-size: 0.9rem;
        }
    }
</style>

    <!-- Boutons d'action -->
    <div class="vintage-actions">
      <h2 class="vintage-section-title">Actions</h2>
      <div class="action-buttons">
        <a href="{% url 'add_book' %}" class="vintage-button book-btn">
          <i class="fas fa-book"></i> Ajouter livre
        </a>
        <a href="{% url 'add_movie' %}" class="vintage-button movie-btn">
          <i class="fas fa-film"></i> Ajouter film
        </a>
        <a href="{% url 'add_series' %}" class="vintage-button series-btn">
          <i class="fas fa-tv"></i> Ajouter série
        </a>
        <a href="{% url 'library' %}" class="vintage-button library-btn">
          <i class="fas fa-book-open"></i> Voir collection
        </a>
      </div>
    </div>

    <!-- Statistiques -->
    <div class="vintage-stats">
      <h2 class="vintage-section-title">Votre collection</h2>
      <div class="stats-grid">
        <div class="vintage-stat">
          <span class="stat-number">{{ num_books }}</span>
          <span class="stat-label">Livres</span>
        </div>
        <div class="vintage-stat">
          <span class="stat-number">{{ num_movies }}</span>
          <span class="stat-label">Films</span>
        </div>
        <div class="vintage-stat">
          <span class="stat-number">{{ num_series }}</span>
          <span class="stat-label">Séries</span>
        </div>
      </div>
    </div>
  </div>

  <style>
    /* Style vintage */
    .vintage-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem;
      background-color: #f5f1e8;
      font-family: 'Times New Roman', serif;
      color: #3a3226;
      border: 1px solid #d4c9b1;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }

    .vintage-header {
      text-align: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #d4c9b1;
    }

    .vintage-header h1 {
      font-size: 2.2rem;
      color: #5c4b37;
      margin-bottom: 0.5rem;
      font-weight: normal;
      letter-spacing: 1px;
    }

    .vintage-subtitle {
      font-size: 1.1rem;
      color: #7a6a51;
      font-style: italic;
    }

    .vintage-search {
      margin-bottom: 2rem;
      padding: 1.5rem;
      background-color: #e8e0d0;
      border: 1px solid #d4c9b1;
      border-radius: 3px;
    }

    .search-box {
      display: flex;
      margin-bottom: 1rem;
    }

    .search-box input {
      flex: 1;
      padding: 0.7rem;
      border: 1px solid #b8a98f;
      background-color: #f9f6ee;
      font-family: 'Times New Roman', serif;
      font-size: 1rem;
    }

    .search-box input:focus {
      outline: none;
      border-color: #8b7a5e;
    }

    .vintage-button {
      display: inline-block;
      padding: 0.7rem 1.2rem;
      margin: 0.3rem;
      border: 1px solid #b8a98f;
      background-color: #d4c9b1;
      color: #3a3226;
      text-decoration: none;
      font-family: 'Times New Roman', serif;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .vintage-button:hover {
      background-color: #c5b89b;
      border-color: #8b7a5e;
    }

    .search-btn {
      background-color: #8b7a5e;
      color: #f9f6ee;
      border: none;
    }

    .filter-row {
      display: flex;
      gap: 1rem;
    }

    .vintage-select {
      flex: 1;
      padding: 0.7rem;
      border: 1px solid #b8a98f;
      background-color: #f9f6ee;
      font-family: 'Times New Roman', serif;
      font-size: 1rem;
      color: #3a3226;
    }

    .vintage-actions {
      margin-bottom: 2rem;
    }

    .vintage-section-title {
      font-size: 1.5rem;
      color: #5c4b37;
      border-bottom: 1px solid #d4c9b1;
      padding-bottom: 0.5rem;
      margin-bottom: 1.5rem;
      font-weight: normal;
    }

    .action-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .book-btn { background-color: #d9c7a7; }
    .movie-btn { background-color: #c4b393; }
    .series-btn { background-color: #b8a98f; }
    .library-btn { background-color: #8b7a5e; color: #f9f6ee; }

    .vintage-stats {
      padding: 1.5rem;
      background-color: #e8e0d0;
      border: 1px solid #d4c9b1;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 1.5rem;
    }

    .vintage-stat {
      text-align: center;
      padding: 1rem;
      background-color: #f9f6ee;
      border: 1px solid #d4c9b1;
    }

    .stat-number {
      display: block;
      font-size: 1.8rem;
      color: #5c4b37;
      margin-bottom: 0.3rem;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #7a6a51;
    }

    /* Icônes Font Awesome */
    .fas {
      margin-right: 0.5rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .filter-row {
        flex-direction: column;
      }
      
      .action-buttons {
        grid-template-columns: 1fr;
      }

.bibli-container {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  padding: 20px;
  background: #eee;
}

.bibli-item {
  position: relative;
  display: inline-block;
  overflow: hidden;
}

.bibli-item img {
  display: block;
  transition: opacity 0.3s ease;
  border-radius: 8px;
}

.bibli-item:hover img {
  opacity: 0.6;
}

.note-overlay {
  position: absolute;
  bottom: 5px;
  left: 5px;
  background: rgba(255, 255, 255, 0.8);
  color: #000;
  font-weight: bold;
  padding: 3px 8px;
  border-radius: 5px;
  font-size: 14px;
  display: none;
}

.bibli-item:hover .note-overlay {
  display: block;
}

    }
  </style>
  
  <script>
  function filterItems() {
    // Récupérer catégorie sélectionnée
    let selectedCategory = 'all';
    document.querySelectorAll('#category-filters .filter-btn').forEach(btn => {
      if (btn.classList.contains('active')) {
        selectedCategory = btn.dataset.category;
      }
    });

    // Récupérer genres sélectionnés
    let selectedGenres = Array.from(document.querySelectorAll('.genre-checkbox:checked')).map(cb => cb.value);

    let items = document.querySelectorAll('#bibli-container img');
    let foundAny = false;

    items.forEach(img => {
      let itemCategory = img.dataset.category;  // on mettra ça dans template
      let itemGenres = img.dataset.genres ? img.dataset.genres.split(',') : [];

      // Vérifier catégorie
      let categoryMatch = (selectedCategory === 'all' || itemCategory === selectedCategory);

      // Vérifier genre (si aucun sélectionné, on ignore)
      let genreMatch = selectedGenres.length === 0 || selectedGenres.every(g => itemGenres.includes(g));

      if (categoryMatch && genreMatch) {
        img.style.display = '';
        foundAny = true;
      } else {
        img.style.display = 'none';
      }
    });

    // Afficher message "Rien trouvé" si rien ne correspond
    let messageEl = document.getElementById('no-results-msg');
    if (!foundAny) {
      if (!messageEl) {
        messageEl = document.createElement('p');
        messageEl.id = 'no-results-msg';
        messageEl.textContent = 'Rien trouvé';
        document.getElementById('bibli-container').after(messageEl);
      }
      messageEl.style.display = 'block';
    } else if (messageEl) {
      messageEl.style.display = 'none';
    }
  }

  // Initialisation : bouton "Tous" actif
  document.querySelectorAll('#category-filters .filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      // retirer active de tous
      document.querySelectorAll('#category-filters .filter-btn').forEach(b => b.classList.remove('active'));
      // activer celui cliqué
      btn.classList.add('active');
      filterItems();
    });
  });

  // Au chargement, activer "Tous"
  window.onload = () => {
    document.querySelector('#category-filters .filter-btn[data-category="all"]').classList.add('active');
    filterItems();
  };
</script>

  <!-- Font Awesome pour les icônes -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
{% endblock %}